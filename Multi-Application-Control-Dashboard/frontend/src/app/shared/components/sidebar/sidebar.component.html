<aside [class.w-64]="isSidebarOpen" [class.w-20]="!isSidebarOpen" 
  class="bg-gradient-to-b from-gray-900 to-gray-800 dark:from-gray-950 dark:to-gray-900 text-white transition-all duration-300 min-h-screen flex flex-col fixed left-0 top-16 bottom-0 z-40 md:static md:top-0 shadow-xl">
  
  <!-- Sidebar Header/Toggle -->
  <div class="p-4 flex items-center justify-between border-b border-gray-700">
    <span *ngIf="isSidebarOpen" class="font-bold text-lg bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
      Control Hub
    </span>
    <button 
      (click)="toggleSidebar()"
      class="p-2 hover:bg-gray-700 rounded-lg transition duration-200"
      [attr.aria-label]="isSidebarOpen ? 'Collapse sidebar' : 'Expand sidebar'"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
          [attr.d]="isSidebarOpen ? 'M15 19l-7-7 7-7' : 'M9 5l7 7-7 7'">
        </path>
      </svg>
    </button>
  </div>

  <!-- Menu Items -->
  <nav class="flex-1 px-3 py-4 space-y-2 overflow-y-auto scrollbar-hide">
    <!-- Main menu items -->
    <ng-container *ngFor="let item of menuItems">
      <!-- Single item (no children) -->
      <ng-container *ngIf="isMenuItemVisible(item) && !item.children">
        <a 
          [routerLink]="item.route"
          routerLinkActive="bg-blue-600 text-white shadow-lg"
          [routerLinkActiveOptions]="routerOptions"
          class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200 group relative"
        >
          <span class="text-xl flex-shrink-0">{{ item.icon }}</span>
          <span *ngIf="isSidebarOpen" class="font-medium truncate">{{ item.label }}</span>
          
          <!-- Badge -->
          <span *ngIf="isSidebarOpen && item.badge" 
            class="ml-auto px-2 py-0.5 bg-red-500 text-white text-xs rounded-full font-semibold">
            {{ item.badge }}
          </span>

          <!-- Tooltip for collapsed sidebar -->
          <div *ngIf="!isSidebarOpen" 
            class="absolute left-full ml-2 px-2 py-1 bg-gray-950 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none z-50">
            {{ item.label }}
          </div>
        </a>
      </ng-container>

      <!-- Collapsible menu group -->
      <ng-container *ngIf="isMenuItemVisible(item) && item.children && hasVisibleChildren(item)">
        <!-- Group header -->
        <button 
          (click)="toggleMenu(item)"
          class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200 group relative text-left"
        >
          <span class="text-xl flex-shrink-0">{{ item.icon }}</span>
          <span *ngIf="isSidebarOpen" class="font-medium truncate flex-1">{{ item.label }}</span>
          
          <!-- Expand/Collapse arrow -->
          <svg *ngIf="isSidebarOpen" 
            class="w-4 h-4 transition duration-200 flex-shrink-0" 
            [class.rotate-180]="isMenuExpanded(item)"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
          </svg>

          <!-- Tooltip for collapsed sidebar -->
          <div *ngIf="!isSidebarOpen" 
            class="absolute left-full ml-2 px-2 py-1 bg-gray-950 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none z-50">
            {{ item.label }}
          </div>
        </button>

        <!-- Submenu items (with animation) -->
               <!-- Submenu items (with animation) -->
        <div *ngIf="isMenuExpanded(item) && isSidebarOpen" 
          class="pl-8 space-y-1 border-l border-gray-700 ml-2">
          <ng-container *ngFor="let child of item.children">
            <a 
              *ngIf="isMenuItemVisible(child)"
              [routerLink]="child.route"
              routerLinkActive="bg-blue-600 text-white"
              class="flex items-center space-x-2 px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition duration-200 group relative"
            >
              <span class="text-lg flex-shrink-0">{{ child.icon }}</span>
              <span class="truncate flex-1">{{ child.label }}</span>
              
              <!-- Badge -->
              <span *ngIf="child.badge" 
                class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full font-semibold flex-shrink-0">
                {{ child.badge }}
              </span>
            </a>
          </ng-container>
        </div>
      </ng-container>
    </ng-container>
  </nav>

  <!-- User Info Footer -->
  <div *ngIf="currentUser" class="p-4 border-t border-gray-700 bg-gray-800 bg-opacity-50">
    <div *ngIf="isSidebarOpen" class="space-y-2">
      <!-- User Name -->
      <div class="text-sm">
        <p class="font-semibold truncate text-white">
          {{ currentUser.firstName }} {{ currentUser.lastName }}
        </p>
        <p class="text-gray-400 text-xs truncate">{{ currentUser.email }}</p>
      </div>

      <!-- Role Badge -->
      <div class="flex items-center space-x-2 pt-2 border-t border-gray-700">
        <span class="text-lg">{{ getRoleIcon() }}</span>
        <span class="text-xs font-semibold text-gray-300">{{ getRoleDisplay() }}</span>
      </div>
    </div>

    <!-- Collapsed view -->
    <div *ngIf="!isSidebarOpen" class="flex justify-center items-center">
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm"
        [title]="currentUser.firstName + ' ' + currentUser.lastName">
        {{ (currentUser.firstName || 'U').charAt(0) }}{{ (currentUser.lastName || '').charAt(0) }}
      </div>
    </div>
  </div>
</aside>

<!-- Overlay for mobile when sidebar is open -->
<div *ngIf="isSidebarOpen && !isDesktop" 
  class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"
  (click)="toggleSidebar()">
</div>
